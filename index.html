<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#0b1020"/>
<title>BYBIT AGENT</title>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<!-- Icons & meta -->
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png">
<link rel="icon" href="icons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
<link rel="manifest" href="site.webmanifest">
<meta property="og:title" content="BYBIT AGENT">
<meta property="og:image" content="icons/icon-512.png">
<meta property="og:type" content="website">
<meta property="og:site_name" content="BYBIT AGENT">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="icons/icon-512.png">

<style>
  :root{
    --bg:#0b1020; --card:#0f172a; --card-2:#0b132b;
    --muted:#94a3b8; --text:#e5e7eb;
    --accent:#7c3aed; --accent-2:#a78bfa;
    --green:#22c55e; --red:#ef4444; --yellow:#eab308; --border:#1f2a44;
    --blue:#60a5fa;
  }
  html, body { height: auto; min-height: 100vh; overflow-x: hidden; overflow-y: auto; }
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 50% -10%, rgba(124,58,237,.12), transparent 60%),
      linear-gradient(180deg, #0b1020, #0a0f1e);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
  }
  /* Контейнер без лишнего отступа снизу */
  .wrap{max-width:1220px; margin:20px auto; padding:0 12px 16px;}
  .title{font-weight:800; font-size:28px; letter-spacing:.2px; text-align:center; margin:4px 0 14px; text-shadow:0 6px 20px rgba(0,0,0,.4);}
  .title img{width:28px; height:28px; vertical-align:-6px; margin-right:8px; border-radius:6px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid var(--border);
        box-shadow:0 10px 40px rgba(2,6,23,.45), inset 0 0 0 1px rgba(255,255,255,.02);
        border-radius:16px; padding:14px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .input{flex:1 1 280px; background:#0d1426; border:1px solid var(--border); color:#e8edf6;
         border-radius:10px; padding:10px 12px; outline:none;}
  .btn{background:#111b34; color:#d6d9e0; border:1px solid var(--border); padding:10px 14px;
       border-radius:12px; cursor:pointer; transition:.2s ease; user-select:none;}
  .btn:hover{transform:translateY(-1px); border-color:#2a3a66;}
  .btn.primary{background:linear-gradient(180deg, #7c3aed, #5b21b6); color:white; border:0; box-shadow:0 10px 24px rgba(124,58,237,.35);}
  .btn.ghost{background:#0d1426}
  .btn.alert{background:#3b0b13; border-color:#7f1d1d; color:#fff;}
  .btn.blink{animation:blink 1.1s infinite;}
  @keyframes blink{ 0%{ box-shadow:0 0 0 0 rgba(239,68,68,.8);} 70%{ box-shadow:0 0 0 14px rgba(239,68,68,0);} 100%{ box-shadow:0 0 0 0 rgba(239,68,68,0);} }
  .seg{display:inline-flex; gap:8px; padding:4px; border-radius:12px; background:#0c1430; border:1px solid var(--border);}
  .seg button{background:transparent; color:#cbd5e1; border:1px solid transparent; padding:8px 12px; border-radius:10px; cursor:pointer}
  .seg button.active{background:rgba(124,58,237,.15); color:#fff; border-color:#5531b5; box-shadow:inset 0 0 0 1px rgba(124,58,237,.3);}
  .layout{display:grid; grid-template-columns: 1fr 1.35fr; gap:12px; margin-top:12px;}
  .leftCol{display:grid; grid-template-rows: 1fr auto; gap:12px; min-height:520px;}
  .pill{display:inline-flex; align-items:center; gap:10px; padding:8px 12px; background:#0c1430; border:1px solid var(--border); border-radius:999px;}
  .kv{display:flex; gap:10px; flex-wrap:wrap;}
  .kv .k{color:#a3b1c6; font-size:12px}
  .kv .v{color:#e5eaf3; font-weight:700}
  .kv .v.red{color:var(--red)!important;} .kv .v.green{color:var(--green)!important;} .kv .v.blue{color:var(--blue)!important;}
  .tag{font-size:12px; padding:5px 10px; background:#0e1731; border:1px solid var(--border); border-radius:999px; color:#b9c2d3}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
  .muted{color:var(--muted);}
  .heading{font-weight:800; letter-spacing:.2px; margin:6px 0 8px;}
  .side{font-weight:900; letter-spacing:.5px; padding:2px 8px; border-radius:8px;}
  .side.long{background:rgba(34,197,94,.1); color:#22c55e; border:1px solid rgba(34,197,94,.35);}
  .side.short{background:rgba(239,68,68,.08); color:#ef4444; border:1px solid rgba(239,68,68,.35);}
  .ttl{font-variant-numeric: tabular-nums; letter-spacing:.3px;}
  .footer{margin-top:10px; color:#94a3b8; font-size:12px}
  .oi-card .rowline{display:flex; justify-content:space-between; gap:10px; margin-top:6px;}
  .mini{font-size:12px;}
  .green{color:var(--green)} .red{color:var(--red)} .yellow{color:var(--yellow)} .blue{color:var(--blue)}
  #chartWrap{height:560px; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#0a1228; position:relative;}
  #tvchart{height:100%;}
  .summary{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:0 0 8px 0;}
  .badge{border:1px solid var(--border); background:#0c1430; border-radius:10px; padding:6px 10px;}

  .drawer{position:absolute; inset:8px; background:rgba(10, 18, 40, .96); border:1px solid var(--border); border-radius:14px; display:none; flex-direction:column;}
  .drawer .head{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--border); gap:8px;}
  .drawer .head .title{font-size:16px; font-weight:800; margin:0;}
  .drawer .close{background:#16213a; border:1px solid var(--border); color:#cbd5e1; border-radius:10px; padding:6px 10px; cursor:pointer;}
  .drawer .tabs{display:flex; gap:8px; margin-left:auto;}
  .drawer .tabs button{background:#16213a; border:1px solid var(--border); color:#cbd5e1; border-radius:10px; padding:6px 10px; cursor:pointer;}
  .drawer .tabs button.active{background:#2b1a52; color:#fff; border-color:#5936c9;}
  .drawerBody{padding:10px; overflow:auto; height:100%;}
  table{width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;}
  th, td{padding:6px 8px; border-bottom:1px dashed #1f2a44; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  th{color:#9fb0cc; font-weight:700;}
  td.mono{font-variant-numeric: tabular-nums;}
  th.c-s, td.c-s{width:72px;} th.c-m, td.c-m{width:90px;} th.c-l, td.c-l{width:120px;}
  .clickable{cursor:pointer;}

  /* MOBILE */
  @media (max-width: 1024px){
    .layout{grid-template-columns: 1fr; gap:12px;}
    .leftCol{grid-template-rows: auto auto; min-height:auto;}
    #chartWrap{height:420px;}
    .title{font-size:24px;}
  }
  @media (max-width: 560px){
    .seg button{padding:6px 10px;}
    .input{flex:1 1 180px; font-size:14px; padding:8px 10px;}
    .btn{padding:8px 10px;}
    .badge{padding:4px 8px;}
    .title{font-size:22px;}
  }

/* === Top button pulse (green <-> red) === */
@keyframes pulseTop {
  0%   { box-shadow:0 0 0 0 rgba(34,197,94,.75); }
  49%  { box-shadow:0 0 0 14px rgba(34,197,94,0); }
  50%  { box-shadow:0 0 0 0 rgba(239,68,68,.75); }
  100% { box-shadow:0 0 0 14px rgba(239,68,68,0); }
}

}
}
#btnTop.topPulse{ animation:pulseTop 1.2s ease-in-out infinite; }

/* === Mobile: cut page right after the chart (no white tail) === */
@media (max-width: 640px){
  html, body { height: auto; min-height: 100vh; overflow-x: hidden; overflow-y: auto; }
  #chartWrap{ height:420px; margin-bottom:0!important; }
}


.btn:active{ transform:scale(1.04); }
</style>

<style id="neon-outline-fix">
/* Neon green outline for Find + Top buttons (no other changes) */
#btnFind, #btnTop{
  border-color: rgba(34,197,94,.85) !important;
  box-shadow:
    0 0 0 1px rgba(34,197,94,.65),
    0 0 12px rgba(34,197,94,.35),
    inset 0 0 0 1px rgba(34,197,94,.35);
}
#btnFind:hover, #btnTop:hover{
  border-color: rgba(34,197,94,.95) !important;
  box-shadow:
    0 0 0 1px rgba(34,197,94,.85),
    0 0 18px rgba(34,197,94,.55),
    inset 0 0 0 1px rgba(34,197,94,.45);
}
</style>

<style id="compact-fit">
  html, body { height: auto; min-height: 100vh; overflow-x: hidden; overflow-y: auto; }
  .wrap{ max-width:1220px; margin:8px auto; padding:0 12px 8px; }
  .card{ padding:10px; }
  .row{ gap:8px; }
  #chartWrap{ height: 420px; }
  .leftCol{ min-height: 420px; }
  .title{ display:none !important; }
  .input{ padding:8px 10px; }
  .btn{ padding:8px 10px; }
  .badge{ padding:4px 8px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <button id="btnWallet" class="btn primary">Wallet</button>
        <input id="sym" class="input mono" placeholder="Например: BTCUSDT" list="symList" spellcheck="false"/>
        <datalist id="symList"></datalist>
        <button id="btnFind" class="btn ghost">Найти</button>
        <button id="btnScan" class="btn ghost">Скан</button>
        <button id="btnAnom" class="btn ghost">Аномалии</button>
        <button id="btnTop" class="btn topPulse">Топ Рост/Падение</button>
      </div>

      <div class="layout">
        <div class="leftCol">
          <div class="card" id="agentCard" style="overflow:auto;">
            <div class="row" style="justify-content:space-between">
              <div class="pill">
                <span class="muted">Сигнал</span>
                <span id="sidePill" class="side">—</span>
              </div><div class="seg mini" id="autoSeg" style="margin:8px 0;">
  <button data-sec="5" class="active">5s</button>
  <button data-sec="10">10s</button>
  <button data-sec="15">15s</button>
</div>
              <div class="pill">
                <span class="muted">Auto</span><span id="autoLbl" class="mono">5s</span>
                <span class="muted">TTL</span><span id="ttl" class="mono ttl">—</span>
              </div>
            </div>

            <div class="heading" id="headline">—</div>
            <div class="kv">
              <div><div class="k">Вход</div><div class="v mono" id="entryV">—</div></div>
              <div><div class="k">Стоп-лосс</div><div class="v mono red" id="slV">—</div></div>
              <div><div class="k">Тейки</div><div class="v mono green" id="tpV">—</div></div>
              <div><div class="k">Цена</div><div class="v mono blue" id="lastV">—</div></div>
              <div><div class="k">RR</div><div class="v mono" id="rrV">—</div></div>
              <div><div class="k">Conf</div><div class="v mono" id="confV">—</div></div>
            </div>

            <div class="heading">Причины / конфлюэнс</div>
            <div id="confList" class="row" style="gap:8px;"></div>

            <div class="footer" id="notes">Если условий нет — «без входа». Сигнал генерируется по реальным свечам Bybit.</div>
          </div>

          <div class="card oi-card">
            <div class="row" style="justify-content:space-between; align-items:center">
              <div class="heading" style="margin:0">Open Interest — <span id="oiTitleSym">—</span></div>
              <div class="seg mini" id="oiSeg">
                <button data-int="5min" class="active">5m</button>
                <button data-int="15min">15m</button>
                <button data-int="1h">1h</button>
              </div>
            </div>
            <div class="rowline mini"><span>Taker Buy (<span id="oiIntA">5m</span>)</span><span id="takerBuy" class="green">—</span></div>
            <div class="rowline mini"><span>Taker Sell (<span id="oiIntB">5m</span>)</span><span id="takerSell" class="red">—</span></div>
            <div class="rowline mini"><span>Open Interest (now)</span><span id="oiNow" class="mono">—</span></div>
            <div class="rowline mini"><span>Δ OI vs prev</span><span id="oiDelta" class="mono">—</span></div>
            <div class="rowline mini"><span>Всего (Buy+Sell, <span id="oiIntC">5m</span>)</span><span id="takerTotal" class="mono">—</span></div>
            <div class="mini muted" id="oiExchange">—</div>
            <div class="mini muted" id="oiUpdated">Обновлено: —</div>
          </div>
        </div>

        <div class="card" id="rightCol" style="position:relative;">
          <div class="summary" id="summaryBar">
            <span class="badge mono clickable" id="sumSymbol">—</span>
            <span class="badge mono" id="sumPrice">—</span>
            <span class="badge mono" id="sumChange">—</span>
            <span class="badge mono" id="sumFunding">Funding: —</span>
          </div>
          <div id="chartWrap">
            <div id="tvchart"></div>
            <div class="drawer" id="drawer">
              <div class="head">
                <div style="display:flex; align-items:center; gap:10px;">
                  <div class="title" id="drawerTitle">—</div>
                  <div class="tabs" id="drawerTabs" style="display:none;">
                    <button data-mode="up" class="active">Топ рост</button>
                    <button data-mode="down">Топ падение</button>
                  </div>
                </div>
                <button id="drawerClose" class="close">✕</button>
              </div>
              <div class="drawerBody" id="drawerBody"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
// -------- Helpers (unchanged core logic) -------
const API = "https://api.bybit.com";
const by = async (path, params={}) => {
  const url = new URL(API + path);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
  const r = await fetch(url, {mode:"cors"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  const j = await r.json();
  if(j.retCode !== 0) throw new Error(j.retMsg || "API error");
  return j.result;
};

async function getTickerSmart(symbol){
  try {
    const r = await by("/v5/market/tickers",{category:"linear", symbol});
    if(r.list && r.list[0]) return {...r.list[0], category:"linear"};
  } catch {}
  const r2 = await by("/v5/market/tickers",{category:"spot", symbol});
  if(r2.list && r2.list[0]) return {...r2.list[0], category:"spot"};
  throw new Error("Symbol not found");
}
async function getAllTickersLinear(){
  try{
    const r = await by("/v5/market/tickers",{category:"linear"});
    return r.list || [];
  }catch(e){ return []; }
}
async function getInstruments(){
  const [lin, spot] = await Promise.all([
    by("/v5/market/instruments-info",{category:"linear"}).catch(()=>({list:[]})),
    by("/v5/market/instruments-info",{category:"spot"}).catch(()=>({list:[]})),
  ]);
  const set = new Set(); const out = [];
  for(const b of [lin.list||[], spot.list||[]]){
    for(const it of b){
      const s = it.symbol;
      if(!set.has(s)){ set.add(s); out.push(s); }
    }
  }
  out.sort(); return out;
}
async function getOI(symbol, category, intervalTime="5min"){
  const r = await by("/v5/market/open-interest",{category, symbol, intervalTime});
  const arr = r.list || [];
  const last = arr.length ? arr[arr.length-1] : null;
  const prev = arr.length>1 ? arr[arr.length-2] : null;
  return {last, prev};
}
async function getTakerFromTrades(symbol, category, n=500){
  const r = await by("/v5/market/recent-trade",{category, symbol, limit: Math.min( (category==='spot')?60:1000, n)});
  const list = r.list || [];
  let buy=0, sell=0;
  for(const t of list){
    const px = +t.price, sz = +t.size;
    const quote = (isFinite(px)&&isFinite(sz)) ? px*sz : 0;
    if(t.side === "Buy") buy += quote; else sell += quote;
  }
  return {buy, sell, total: buy+sell};
}
async function getKlines(symbol, category, interval="5", limit=200){
  const r = await by("/v5/market/kline",{category, symbol, interval, limit});
  return r.list ? r.list.map(row => ({
    ts:+row[0], open:+row[1], high:+row[2], low:+row[3], close:+row[4], volume:+row[5]
  })).sort((a,b)=> a.ts-b.ts) : [];
}

// ----------------- UI / State -----------------
const $ = id => document.getElementById(id);
const autoSeg = $("autoSeg");
const symInp = $("sym");
const btnFind = $("btnFind");
const btnScan = $("btnScan");
const btnAnom = $("btnAnom");
const btnTop = $("btnTop");
const drawer = $("drawer");
const drawerTitle = $("drawerTitle");
const drawerBody = $("drawerBody");
const drawerClose = $("drawerClose");
const drawerTabs = $("drawerTabs");
const oiSeg = $("oiSeg");
["A","B","C"].forEach(k=> $("oiInt"+k).textContent = "5m");

let autoTimer = null, detectTimer = null;
let currentSymbol = "BTCUSDT", currentCategory = "linear";
let cachedTickers = [], latestAnomalies=[], latestSetups=[], latestTop={up:[],down:[]};

function setAuto(sec){
  $("autoLbl").textContent = sec + "s";
  if (autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(()=> refreshAll(currentSymbol, currentCategory), sec*1000);
  if (detectTimer) clearInterval(detectTimer);
  detectTimer = setInterval(runDetections, Math.max(10, sec*2)*1000);
  refreshAll(currentSymbol, currentCategory);
}
autoSeg.addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  [...autoSeg.children].forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); setAuto(parseInt(b.dataset.sec,10)||5);
});
setAuto(5);

// автокомплит списка монет
(async ()=>{
  try{
    const syms = await getInstruments();
    const dl = $("symList");
    dl.innerHTML = syms.map(s=> `<option value="${s}">`).join("");
  }catch(e){}
})();

symInp.addEventListener('input', ()=> symInp.value = symInp.value.toUpperCase());
symInp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnFind.click(); } });

oiSeg.addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  [...oiSeg.children].forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const lbl = b.textContent;
  ["A","B","C"].forEach(k=> $("oiInt"+k).textContent = lbl);
  refreshOI(currentSymbol, currentCategory);
});

btnTop.addEventListener('click', ()=> showTop());
btnAnom.addEventListener('click', ()=> showTable("Аномалии", latestAnomalies));
btnScan.addEventListener('click', ()=> showTable("Скальп/Интрадей — сетапы", latestSetups));
btnFind.addEventListener('click', async ()=>{
  const symbol = (symInp.value || "BTCUSDT").toUpperCase();
  await selectSymbol(symbol);
});

drawerTabs.addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  [...drawerTabs.children].forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  showTop(b.dataset.mode);
});
drawerClose.addEventListener('click', ()=> drawer.style.display='none');

$("sumSymbol").addEventListener('click', ()=>{
  const next = prompt("Введите символ Bybit (например BTCUSDT):", currentSymbol) || currentSymbol;
  selectSymbol(next.toUpperCase());
});

drawerBody.addEventListener('click', (e)=>{
  const cell = e.target.closest('[data-symbol]');
  if(!cell) return;
  const symbol = cell.getAttribute('data-symbol');
  selectSymbol(symbol);
  drawer.style.display='none';
});

async function selectSymbol(symbol){
  try {
    const t = await getTickerSmart(symbol);
    currentCategory = t.category || "linear";
    currentSymbol = symbol;
    symInp.value = symbol;
    loadSymbol(symbol, currentCategory, t);
  } catch(e){
    alert("Символ не найден на Bybit: "+symbol);
  }
}

// ------------ Main loaders ------------
async function loadSymbol(symbol, category, preTicker=null){
  await refreshAll(symbol, category, true, preTicker);
  mountTV(symbol, category);
  runDetections();
}
async function refreshAll(symbol, category, first=false, preTicker=null){
  let t = preTicker;
  try{
    if(!t) t = await getTickerSmart(symbol);
    renderSummary({
      category: t.category,
      symbol,
      lastPrice: +(t.lastPrice||0),
      changePct: +(t.price24hPcnt||0),
      fundingRate: (t.fundingRate!=null? t.fundingRate : null)
    });
  }catch(e){
    renderSummary({symbol, lastPrice: NaN, changePct: NaN, fundingRate: null, category:"unknown"});
  }
  refreshOI(symbol, category);
  await computeAndRenderSignal(symbol, category);
}

// Summary
function renderSummary({symbol, lastPrice, changePct, fundingRate, category}){
  $("sumSymbol").textContent = `${symbol} • ${String(category||'').toUpperCase()}`;
  $("sumPrice").textContent = isFinite(lastPrice) ? lastPrice : "—";
  const ch = isFinite(changePct) ? (changePct*100).toFixed(2)+"%" : "—";
  $("sumChange").textContent = ch;
  $("sumChange").style.color = (changePct>0)? "var(--green)" : (changePct<0? "var(--red)":"var(--text)");
  $("sumFunding").textContent = "Funding: " + (fundingRate!=null ? (+fundingRate*100).toFixed(4)+"%" : "—");
  $("oiTitleSym").textContent = symbol;
}

// OI + taker flows
async function refreshOI(symbol, category){
  const intBtn = oiSeg.querySelector(".active") || oiSeg.children[0];
  const intervalTime = intBtn.dataset.int;
  try{
    const {last, prev} = await getOI(symbol, category, intervalTime);
    const nowVal = last ? (+last.openInterestValue || +last.openInterest || NaN) : NaN;
    const prevVal= prev ? (+prev.openInterestValue || +prev.openInterest || NaN) : NaN;
    $("oiExchange").textContent = `${symbol} • Bybit ${category}`;
    $("oiNow").textContent = isFinite(nowVal) ? formatVol(nowVal) : "—";
    $("oiDelta").textContent = (isFinite(nowVal)&&isFinite(prevVal)) ? (nowVal-prevVal).toFixed(0) : "—";
  }catch(e){
    $("oiNow").textContent = "—"; $("oiDelta").textContent="—";
  }
  try{
    const tv = await getTakerFromTrades(symbol, category, 800);
    const tot = tv.total||0;
    $("takerBuy").textContent = formatVol(tv.buy) + (tot? (" " + ((tv.buy/tot*100).toFixed(1))+"%"):"");
    $("takerSell").textContent = formatVol(tv.sell) + (tot? (" " + ((tv.sell/tot*100).toFixed(1))+"%"):"");
    $("takerTotal").textContent = formatVol(tot);
    $("oiUpdated").textContent = "Обновлено: " + new Date().toLocaleTimeString();
  }catch(e){
    ["takerBuy","takerSell","takerTotal"].forEach(id=> $(id).textContent = "—");
  }
}
function formatVol(v){
  v = +v;
  if(!isFinite(v)) return "—";
  if (v>=1e12) return (v/1e12).toFixed(2)+" T";
  if (v>=1e9) return (v/1e9).toFixed(2)+" B";
  if (v>=1e6) return (v/1e6).toFixed(2)+" M";
  if (v>=1e3) return (v/1e3).toFixed(2)+" K";
  return v.toFixed(0);
}

// TradingView
function tvSymbolFromBybit(symbol, category){
  if (category === "linear" || category === "inverse") return "BYBIT:" + symbol + ".P";
  return "BYBIT:" + symbol;
}
function mountTV(symbol, category){
  const tvsym = tvSymbolFromBybit(symbol, category);
  try{ if(window.tvWidget){ window.tvWidget.remove(); window.tvWidget = null; } }catch{}
  setTimeout(()=>{
    try{
      window.tvWidget = new TradingView.widget({
        autosize: true, symbol: tvsym, interval: "15",
        container_id: "tvchart", timezone: "Etc/UTC", theme: "dark",
        style: "1", locale: "ru", toolbar_bg: "#0f172a",
        enable_publishing: false, hide_side_toolbar: false,
        withdateranges: true, allow_symbol_change: true, studies: [],
      });
    }catch(e){}
  }, 50);
}

// --------- Signal Engine ----------
function ema(series, period){ const k = 2/(period+1); let ema=[], prev=null; for(const v of series){ if(prev===null){ prev=v; ema.push(v); } else { prev = v*k + prev*(1-k); ema.push(prev); } } return ema; }
function atr(candles, period=14){
  if(candles.length<2) return [];
  let trs=[0];
  for(let i=1;i<candles.length;i++){
    const c=candles[i], p=candles[i-1];
    const tr = Math.max(c.high-c.low, Math.abs(c.high-p.close), Math.abs(c.low-p.close));
    trs.push(tr);
  }
  const out=[...trs];
  for(let i=1;i<trs.length;i++){ out[i] = (out[i-1]*(period-1)+trs[i])/period; }
  return out;
}
async function computeAndRenderSignal(symbol, category){
  try{
    const kl = await getKlines(symbol, category, "5", 300);
    if(kl.length<60){ return renderNoTrade("Недостаточно данных"); }
    const closes = kl.map(k=>k.close);
    const ema20i = ema(closes, 20);
    const ema50i = ema(closes, 50);
    const atr14 = atr(kl, 14);
    const n = closes.length-1;
    const last = closes[n];
    const mom = closes[n]-closes[n-1];
    const trend = ema20i[n] - ema50i[n];
    const strongTrend = Math.abs(trend) > (0.0008 * last);
    let side = trend>=0 ? "LONG" : "SHORT";
    if(!strongTrend){ if(mom>0) side="LONG"; else if(mom<0) side="SHORT"; }
    const r = Math.max(1e-6, atr14[n]);
    const entry = side==="LONG" ? +(last - 0.2*r).toFixed(4) : +(last + 0.2*r).toFixed(4);
    const sl    = side==="LONG" ? +(entry - 1.25*r).toFixed(4) : +(entry + 1.25*r).toFixed(4);
    const tp1   = +(entry + (side==="LONG"?1:-1)*1.0*r).toFixed(4);
    const tp2   = +(entry + (side==="LONG"?1:-1)*2.0*r).toFixed(4);
    const tp3   = +(entry + (side==="LONG"?1:-1)*3.0*r).toFixed(4);
    const rr = +(Math.abs(tp2-entry)/Math.abs(entry-sl)).toFixed(2);
    let confTags = []; let confidence = 55 + (strongTrend?10:0);
    confTags.push(strongTrend? "Тренд сильный" : "Тренд слабый");
    try{
      const tv = await getTakerFromTrades(symbol, category, 500);
      const imb = (tv.buy - tv.sell) / Math.max(1, (tv.buy + tv.sell));
      confTags.push(`Taker ${imb>0? 'Buy':'Sell'} ${(Math.abs(imb)*100).toFixed(1)}%`);
      confidence += Math.min(10, Math.floor(Math.abs(imb)*100/6));
    }catch{}
    confidence = Math.max(40, Math.min(92, confidence));
    renderSignal({
      symbol, last_price:last, entry:{type:'limit', price:entry, method: strongTrend? 'trend':'momentum'},
      stop_loss:sl, take_profit:[tp1,tp2,tp3], rr, confidence,
      side, regime: trend>=0?"trend-up":"trend-down", confluence: confTags,
      invalidates_if: side==="LONG" ? ["Закрытие ниже EMA50"] : ["Закрытие выше EMA50"],
      notes: side==="LONG" ? "Лонг по тренду/моментуму. SL ≈ 1.25×ATR." : "Шорт по тренду/моментуму. SL ≈ 1.25×ATR.",
      ttl_minutes: 30, timestamp: new Date().toISOString()
    });
  }catch(e){ renderNoTrade("Ошибка данных"); }
}
let ttlTimer=null;
function renderNoTrade(msg){
  $("sidePill").className='side'; $("sidePill").textContent='—';
  $("headline").textContent = "Без входа • " + msg;
  const entryEl = $("entryV"); entryEl.textContent="—"; entryEl.classList.remove('green','red');
  $("slV").textContent="—"; $("tpV").textContent="—"; $("lastV").textContent="—";
  ["rrV","confV"].forEach(id=> $(id).textContent="—");
  $("confList").innerHTML='';
  $("notes").textContent = "Ожидание условий. Автообновление активно.";
  clearInterval(ttlTimer); $("ttl").textContent="—";
}
function renderSignal(sig){
  const long = sig.side==='LONG';
  const sidePill = $("sidePill");
  sidePill.className = 'side ' + (long?'long':'short');
  sidePill.textContent = sig.side;
  $("headline").textContent = `${sig.side} ${sig.symbol}`;
  const entryEl = $("entryV"); entryEl.textContent = sig.entry.price;
  entryEl.classList.remove('green','red'); entryEl.classList.add(long?'green':'red');
  $("slV").textContent = sig.stop_loss;
  $("tpV").textContent = sig.take_profit.join(' / ');
  $("lastV").textContent = sig.last_price;
  $("rrV").textContent = sig.rr;
  $("confV").textContent = sig.confidence + '%';
  const list = $("confList"); list.innerHTML='';
  (sig.confluence||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; list.appendChild(s); });
  $("notes").textContent = sig.notes;
  clearInterval(ttlTimer);
  let left = sig.ttl_minutes*60; const ttlLbl = $("ttl");
  const fmt = s=>{ const m=Math.floor(s/60),k=s%60; return `${String(m).padStart(2,'0')}:${String(k).padStart(2,'0')}`; };
  ttlLbl.textContent = fmt(left);
  ttlTimer = setInterval(()=>{ left=Math.max(0,left-1); ttlLbl.textContent=fmt(left); if(left===0) clearInterval(ttlTimer); },1000);
}

// -------------- Detections --------------
async function runDetections(){
  try{
    const list = await getAllTickersLinear();
    cachedTickers = list;
    if (!Array.isArray(list) || list.length===0) return;
    const rows = list.map(t=> ({
      symbol: t.symbol, last:+t.lastPrice, change:+t.price24hPcnt, vol:+t.turnover24h || +t.volume24h || 0,
      high:+t.highPrice24h || NaN, low:+t.lowPrice24h || NaN, funding:(t.fundingRate!=null? +t.fundingRate : null)
    })).filter(r=>isFinite(r.last));

    const vols = rows.map(r=>r.vol).filter(v=>isFinite(v) && v>0).sort((a,b)=>a-b);
    const p90 = vols.length? vols[Math.floor(vols.length*0.9)] : Infinity;
    const med = vols.length? vols[Math.floor(vols.length*0.5)] : 0;

    const anomalies = [];
    for (const r of rows){
      const natr = (isFinite(r.high)&&isFinite(r.low)&&isFinite(r.last) && r.last>0) ? (r.high-r.low)/r.last : 0;
      const flags = [];
      if (Math.abs(r.change) >= 0.08) flags.push(`Δ% ${(r.change*100).toFixed(1)}%`);
      if (natr >= 0.06) flags.push(`NATR24h ${(natr*100).toFixed(1)}%`);
      if (r.vol >= p90) flags.push("Объём ↑");
      if (flags.length){
        const score = flags.length*10 + Math.abs(r.change)*100 + natr*100 + (r.vol>=p90?10:0);
        anomalies.push({...r, natr, flags, score});
      }
    }
    anomalies.sort((a,b)=> b.score - a.score);
    latestAnomalies = anomalies.slice(0, 50);
    btnAnom.classList.toggle('blink', latestAnomalies.length>0);

    const setups = [];
    for (const r of rows){
      const trendUp = r.change > 0.02;
      const trendDn = r.change < -0.02;
      const liquid = r.vol >= med;
      const fundingOK = (r.funding==null) || Math.abs(r.funding) < 0.01;
      if (liquid && fundingOK && (trendUp || trendDn)){
        const side = trendUp ? 'LONG' : 'SHORT';
        const score = (Math.abs(r.change)*100) + (r.vol/ (med||1)) * 2;
        const reason = trendUp? "Тренд ↑ + ликвидность" : "Тренд ↓ + ликвидность";
        setups.push({...r, side, reason, score});
      }
    }
    setups.sort((a,b)=> b.score - a.score);
    latestSetups = setups.slice(0, 50);
    btnScan.classList.toggle('blink', latestSetups.length>0);

    const up = [...rows].sort((a,b)=> b.change - a.change).slice(0, 50);
    const down = [...rows].sort((a,b)=> a.change - b.change).slice(0, 50);
    latestTop = {up, down};
  }catch(e){}
}

// Drawer/Table
function showTop(mode='up'){
  drawerTabs.style.display = 'flex';
  [...drawerTabs.children].forEach(x=> x.classList.remove('active'));
  drawerTabs.querySelector(`[data-mode="${mode}"]`).classList.add('active');
  const arr = latestTop[mode] || [];
  drawerTitle.textContent = mode==='up' ? 'Топ роста (24h %)' : 'Топ падения (24h %)';
  drawerBody.innerHTML = buildTable(arr);
  drawer.style.display = 'flex';
__jumpToDrawer(drawer);
}
function showTable(title, arr){
  drawerTabs.style.display = 'none';
  drawerTitle.textContent = title;
  drawerBody.innerHTML = buildTable(arr);
  drawer.style.display = 'flex';
__jumpToDrawer(drawer);
}
function buildTable(arr){
  if(!arr || arr.length===0) return '<div class="muted">Ничего не найдено.</div>';
  let head = '<table><thead><tr>\
  <th class="c-l">Symbol</th>\
  <th class="c-m">Last</th>\
  <th class="c-s">%24h</th>\
  <th class="c-s">Fund</th>\
  <th class="c-m">Vol24h</th>\
  <th class="c-s">Score</th>\
  <th class="c-l">Note</th>\
  </tr></thead><tbody>';
  let rows = arr.map(x=>{
    const pct = isFinite(x.change)? (x.change*100).toFixed(2)+'%' : '—';
    const fund = (x.funding!=null)? (x.funding*100).toFixed(4)+'%' : '—';
    const vol = isFinite(x.vol)? formatVol(x.vol) : '—';
    const reason = x.flags? x.flags.join(', ') : (x.reason||'');
    const color = x.change>0?'var(--green)':(x.change<0?'var(--red)':'inherit');
    return `<tr class="clickable" data-symbol="${x.symbol}">
      <td data-symbol="${x.symbol}">${x.symbol}</td>
      <td class="mono" data-symbol="${x.symbol}">${isFinite(x.last)? x.last : '—'}</td>
      <td class="mono" style="color:${color}" data-symbol="${x.symbol}">${pct}</td>
      <td class="mono" data-symbol="${x.symbol}">${fund}</td>
      <td class="mono" data-symbol="${x.symbol}">${vol}</td>
      <td class="mono" data-symbol="${x.symbol}">${(x.score||0).toFixed(1)}</td>
      <td data-symbol="${x.symbol}">${reason}</td>
    </tr>`;
  }).join('');
  return head + rows + '</tbody></table>';
}

// Boot
selectSymbol("BTCUSDT");
runDetections();
</script>

<script id="mobile-jump-to-drawer">
(function(){
  function isMobile(){ return window.matchMedia('(max-width: 1024px)').matches; }
  window.__jumpToDrawer = function(el){
    try{
      if(!el) return;
      if(isMobile()){
        setTimeout(function(){
          try{
            el.scrollIntoView({behavior:'smooth', block:'start'});
            setTimeout(function(){ window.scrollBy({top:-10, left:0, behavior:'instant'}); }, 220);
          }catch(e){}
        }, 40);
      }
    }catch(e){}
  };
})();
</script>

<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){fn()} else document.addEventListener('DOMContentLoaded',fn); }
  ready(function(){
    var btn = document.getElementById('btnWallet');
    if(!btn) return;
    async function connectWallet(){
      try{
        const provider = new WalletConnectProvider.default({
          rpc: {56: "https://bsc-dataseed.binance.org/"},
          chainId: 56
        });
        await provider.enable();
        const web3 = new Web3(provider);
        const accounts = await web3.eth.getAccounts();
        const addr = (accounts && accounts[0]) || '';
        if(addr){
          localStorage.setItem('walletAddress', addr);
          btn.textContent = 'Wallet ✓ ' + addr.slice(0,6) + '…';
          btn.classList.add('connected');
          btn.disabled = true;
          console.log('Wallet connected:', addr);
        }
      }catch(e){
        console.error('Wallet connect error', e);
        alert('Не удалось подключить кошелёк');
      }
    }
    btn.addEventListener('click', connectWallet);
    var saved = localStorage.getItem('walletAddress');
    if(saved){
      btn.textContent = 'Wallet ✓ ' + saved.slice(0,6) + '…';
      btn.classList.add('connected');
      btn.disabled = true;
    }
  });
})();
</script>
</body>
</html>
